<?php
/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    INCLUDES
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	namespace Tests\PHPUnit\Feature\Listeners;

	// Laravel
	use Tests\PHPUnit\TestCase;
	use Illuminate\Foundation\Testing\RefreshDatabase;
	use Illuminate\Auth\Events\Verified;
	use Illuminate\Support\Facades\Bus;

	// App
	use App\Listeners\VerifiedUserListener;
	use App\Jobs\Newsletter\AddUserToNewsletter;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    CLASS DECLARATION
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


class VerifiedUserListenerTest extends TestCase {

	use RefreshDatabase;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    USER ROLE
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_change_role_to_user() {

		// arrange
		$user = $this->createUser();
		$user->changeRole('user', 'guest');
		$this->assertTrue($user->isGuest());

		// act
		$listener = new VerifiedUserListener();
		$event = new Verified($user);
		$listener->handle($event);

		// assert
		$user = $user->fresh();
		$this->assertTrue($user->isUser());
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    NEWSLETTER
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_newsletter_job_dispatched() {

		// arrange
		Bus::fake();
		$user = $this->createUser(['newsletter' => true]);

		// act
		$listener = new VerifiedUserListener();
		$event = new Verified($user);
		$listener->handle($event);

		// assert
		Bus::assertDispatched(AddUserToNewsletter::class);
	}


	public function test_newsletter_job_not_dispatched() {

		// arrange
		Bus::fake();
		$user = $this->createUser(['newsletter' => false]);

		// act
		$listener = new VerifiedUserListener();
		$event = new Verified($user);
		$listener->handle($event);

		// assert
		Bus::assertNotDispatched(AddUserToNewsletter::class);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */

} // end class

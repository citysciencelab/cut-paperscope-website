<?php
/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    INCLUDES
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	namespace Tests\PHPUnit\Feature\Http\Controllers\Backend\Base;

	// Laravel
	use Tests\PHPUnit\TestCase;
	use Illuminate\Foundation\Testing\RefreshDatabase;
	use Illuminate\Support\Facades\Http;
	use Mockery;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    CLASS DECLARATION
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


class DashboardControllerTest extends TestCase {

	use RefreshDatabase;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	DATA
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_get_dashboard() {

		// arrange
		$this->seed();
		$this->loginAsAdmin();

		// act
		$data = $this->getData('/api/backend/dashboard');

		// assert
		$this->assertIsArray($data);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	USERS
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_get_dashboard_users() {

		// arrange
		$this->seed();
		$this->loginAsAdmin();

		// act
		$data = $this->getData('/api/backend/dashboard');

		// assert
		$this->assertArrayHasKey('users',$data);
		$this->assertTrue($data['users']['registered'] > 0);
		$this->assertTrue($data['users']['guests'] == 0);
		$this->assertTrue($data['users']['blocked'] == 0);
	}


	public function test_get_dashboard_users_unauthenticated() {

		// arrange
		$this->seed();

		// act
		$response = $this->get('/api/backend/dashboard');

		// assert
		$response->assertStatus(302);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	MATOMO ANALYTICS
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	/** @dataProvider provideAnalyticsRange */
	public function test_get_dashboard_analytics(string $range) {

		// arrange: force matomo settings
		config(['app.matomo_url' => 'https://matomo.example.com']);
		config(['app.matomo_token' => '123']);

		// arrange
		$this->mockMatomoRequest($range);
		$this->seed();
		$this->loginAsAdmin();

		// act
		$data = $this->getData('/api/backend/dashboard/analytics/'.$range);

		// assert
		$this->assertIsArray($data);
	}


	static public function provideAnalyticsRange() {

		return [
			"week" => ['week'],
			"month" => ['month'],
			"year" => ['year'],
		];
	}


	public function test_get_dashboard_analytics_disabled() {

		// arrange
		config(['app.matomo_url' => null]);
		config(['app.matomo_token' => null]);
		$this->seed();
		$this->loginAsAdmin();

		// act
		$response = $this->get('/api/backend/dashboard/analytics/week');

		// assert
		$status = $response->json('status');
		$this->assertEquals('success', $status);
	}


	protected function mockMatomoRequest(string $range) {

		$response = [];
		$response[$range] = ['visits' => 100];

		Http::fake([
			config('app.matomo_url').'*' => Http::response($response[$range], 200),
		]);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


} // end class

<?php
/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    INCLUDES
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	namespace Tests\PHPUnit\Feature\Http\Controllers\App;

	// Laravel
	use Tests\PHPUnit\TestCase;
	use Illuminate\Foundation\Testing\RefreshDatabase;

	// App
	use App\Models\App\Project;
	use App\Models\App\Base\Fragment;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//    CLASS DECLARATION
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


class ProjectControllerTest extends TestCase {

	use RefreshDatabase;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	MODEL LIST
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_get_public_list() {

		$this->seed();
		$user = $this->loginAsUser();

		// arrange
		Project::factory()->public()->create(['user_id' => $user->id]);

		// act
		$data = $this->getData('/api/project');

		// assert: correct data
		$this->assertIsArray($data);
		$this->assertEquals('project',$data[0]['type']);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	MODEL GET
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_get_public() {

		// arrange
		$project = Project::factory()->public()->create();

		// act
		$data = $this->getData('/api/project/'.$project->slug);

		// assert: check response is project model
		$this->assertEquals('project',$data['type']);
	}


	public function test_get_public_not_found() {

		$this->getError('/api/project/3ec9fc3b-a102-40b6-bd61-743f8bd2403b');
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	MODEL PREVIEW
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_get_preview() {

		$user = $this->loginAsEditor();

		// arrange
		$project = Project::factory()->create(['public' => false]);
		Fragment::factory()->create(['public' => true, 'parent_id' => $project->id,'parent_type' => Project::class]);
		Fragment::factory()->create(['public' => false, 'parent_id' => $project->id,'parent_type' => Project::class]);

		// act
		$data = $this->getData('/api/project/'.$project->slug, [], [
			'X-Preview' => $user->id,
		]);

		// assert: response is project with both fragments
		$this->assertEquals('project',$data['type']);
		$this->assertEquals($project->id,$data['id']);
		$this->assertCount(2,$data['fragments']);
	}


	public function test_user_not_allowed_to_get_preview() {

		$user = $this->loginAsUser();

		// arrange
		$project = Project::factory()->create(['public' => false]);

		// act
		$response = $this->get('/api/project/'.$project->slug, [
			'X-Preview' => $user->id,
		]);

		// assert
		$response->assertJson(['status'=>'error']);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	META TAGS
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function test_meta_tags_in_html() {

		// arrange
		$project = Project::factory()->public()->create();

		// act
		$response = $this->get($project->slug);

		// assert: correct meta tags
		$response->assertSee('<meta name="description" content="'.$project['meta_description'],false);
		$response->assertSee('<meta property="og:description" content="'.$project['social_description'],false);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


} // end class


<?php
/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	INCLUDES
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	namespace App\Http\Controllers\Backend\Base;

	// Laravel
	use App\Http\Controllers\Controller;
	use Illuminate\Http\Request;
	use Illuminate\Support\Facades\Http;
	use Illuminate\Support\Facades\Cache;
	use Illuminate\Support\Str;

	// App
	use App\Models\Auth\User;



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	CLASS CONSTRUCT
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


class DashboardController extends Controller {



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	GET
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function get(Request $request): mixed {

		$data = [
			'users' => [
				'registered' => User::count(),
				'guests' => User::where('email_verified_at')->count(),
				'blocked' => User::where('blocked',1)->count(),
			],
		];

		return $this->responseData($data);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
//	MATOMO
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


	public function getAnalytics(string $range, Request $request): mixed {

		// skip gracefully if matomo is not enabled
		if(!config('app.matomo_url') || !config('app.matomo_token')) {
			return $this->responseSuccess();
		}

		$data = Cache::remember('dashboard_analytics_'.$range, 60 * 3, function() use ($range) {

			switch($range) {
				case 'week': $days = 7; break;
				case 'month': $days = 30; break;
				case 'year': $days = 365; break;
			}

			$url = Str::finish(config('app.matomo_url'),'/').'?module=API&method=VisitsSummary.getVisits';
			$url .= '&idSite=1';
			$url .= '&period=day';
			$url .= '&date=last'.$days;
			$url .= '&format=JSON';

			$response = Http::post($url, ['token_auth' => config('app.matomo_token')]);

			return $response->json();
		});

		return $this->responseData($data);
	}



/*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// */


} // end class
